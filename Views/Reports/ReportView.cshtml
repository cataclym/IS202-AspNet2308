@model Kartverket.Models.ReportViewModel


@{
    ViewData["Title"] = "Registrert rapport";
    var municipalityCountyNames = (MunicipalityCountyNames?) ViewData["MunicipalityInfo"];
}

<!DOCTYPE html>
<body class="report-view">
@if (Model.IsAdmin)
{
<h2 class="display-4 center-horizontal">Rapport ID: @Model.ReportId</h2>
}
else
{
<h2 class="display-4 center-horizontal">Rapport detaljer</h2>
}

@if (Model.AssignedAdminId != null)
{
    <p><strong>Saksbehandler:</strong> @Model.AssignedAdminUsername</p>
    <p><strong>Saksbehandler ID:</strong> @Model.AssignedAdminId</p>
}
else if (Model.IsAdmin)
{
    <!-- Display the Claim button -->
    <div class="center-horizontal">
        <a asp-action="Claim" asp-route-id="@Model.ReportId" class="claim-btn">Ta Rapport
            <i class="bi bi-box-arrow-in-down"></i></a>

    </div>
}
<div class="center-horizontal">
    <a asp-controller="Reports" asp-action="EditMapReport" asp-route-id="@Model.ReportId" class="claim-btn">
        Endre rapport <i class="bi bi-box-arrow-in-down"></i>
    </a>
</div>

<div class="report-container">
    <!-- Left Column: Map and Report Details -->
    <div class="left-column">
        <div id="map" class="styledMap-report"></div>
        <div class="reportstats-container">
            @if (Model.IsAdmin)
            {
                <p><strong>Sendt inn av:</strong> @Model.Username</p>
            }
            <p><strong>Beskrivelse:</strong> @Model.FirstMessage</p>
            <p><strong>Oprettet:</strong> @Model.CreatedAt</p>
            <p><strong>Fylke:</strong> @Model.MunicipalityInfo?.fylkesnavn</p>
            <p><strong>Kommune:</strong> @Model.MunicipalityInfo?.kommunenavn</p>
            <p><strong>Koordinater:</strong> @Model.Coordinates</p>
        </div>
    </div>

    <!-- Right Column: Status Buttons and Chat History -->
    <div class="right-column">
        <p class="center-horizontal"><strong>Status:</strong> @Model.Status</p>
        @if (Model.IsAdmin)
        {
            <div class="status-dropdown">
                <form asp-action="UpdateStatus" asp-controller="Reports" method="post">
                    <input type="hidden" name="reportId" value="@Model.ReportId" />
                    <button class="dropdown-btn" type="button" onclick="toggleDropdown()">Endre status ▼</button>
                    <div class="dropdown-content">
                        <button class="dropdown-btn-a" type="submit" name="status" value="Behandlet">Behandlet</button>
                        <button class="dropdown-btn-a" type="submit" name="status" value="Under_behandling">Under behandling</button>
                        <button class="dropdown-btn-a" type="submit" name="status" value="Ubehandlet">Ubehandlet</button>
                    </div>
                </form>
            </div>
        }

        <div class="chat-history">
            <h3>Chat Historikk</h3>
            <p>Samtale startet @Model.CreatedAt</p>
            <div class="chat-message">
                @foreach (var message in Model.Messages)
                {
                    <p style="font-weight: normal;">
                        <strong>@message.Username</strong> - @message.CreatedAt
                    </p>
                    <p id="message">@message.Message</p>
                }
            </div>
            <form asp-action="AddMessage" asp-controller="Reports" method="post">
                <div class="chat-input">
                    <input type="hidden" name="ReportId" value="@Model.ReportId" />
                    <input type="text" name="MessageText" required minlength="1" placeholder="Skriv melding her..">
                    <button>➤</button>
                </div>
            </form>
        </div>
    </div>
</div>
   <div class="center-horizontal">
    <form id="delete-form" asp-action="DeleteConfirmed" asp-route-id="@Model.ReportId" method="post">
        <button type="button" class="delete-btn" onclick="confirmDelete()">Slett rapport</button>
    </form>
</div>

</body>


@section Scripts {
    <script>
    // Henter kart uten gps og search
    const map = lagKart({ zoomControl: true }, false, false);
    
    // Skru av alt som flytter på kartet 
    map.dragging.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.scrollWheelZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
    if (map.tap) map.tap.disable();

    // Hent kartlag fra layout, legg til i kart
    kartLag.Land.addTo(map); 

    // Hent GeoJSON Object fra modellen
    const geoJSONObject = @Html.Raw(Model.StringKoordinaterLag);

    if (geoJSONObject.features[0].geometry.type === "Point") {
        console.log("GeoJSON er Point")
        geoJSONObject.features.map(feature => {
            feature.geometry.coordinates = feature.geometry.coordinates.flat(2);
            console.log("Koordinater på point: " + feature.geometry.coordinates);
            return feature;
        });
    }
    
    // For feilsøking, logg geoJSONObject
    console.log("GeoJSON: ", geoJSONObject);
    
    // Hvis GeoJSON-data eksisterer, legg til på kartet
    if (geoJSONObject !== null) {
        try {
            // Legg til GeoJSON-laget på kartet
            const geoLayer = L.geoJSON(geoJSONObject).addTo(map);

            // Juster kartets visning til å passe GeoJSON-dataene
            const bounds = geoLayer.getBounds();
            map.fitBounds(bounds);
        } catch (error) {
            console.error("Feil ved parsing av GeoJSON-data:", error);
        }
    } else {
        console.error("Ingen GeoJSON-data funnet");
    }

    function toggleDropdown() {
        console.log("Dropdown-knappen ble klikket"); // Legg til dette for å feilsøke
        const dropdownMenu = document.querySelector(".dropdown-content");
        dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    }

    const chatHistorikk = document.querySelector('.chat-message');

    function scrollToBottom() {
        chatHistorikk.scrollTop = chatHistorikk.scrollHeight;
    }

    // Kall funksjonen hver gang en ny melding legges til, eller når siden lastes
    scrollToBottom();

     function confirmDelete() {
        if (confirm("Er du sikker på at du vil slette denne rapporten?")) {
            document.getElementById("delete-form").submit();
        }
    }

    </script>

}
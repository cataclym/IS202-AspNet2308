@model FeilMeldingsModel

@{
    ViewData["Title"] = "Registrer feil på kart";
}

<!DOCTYPE html>

<html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link
        rel="stylesheet"
        href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css"/>
</head>
<body>
<div>
    <div id="map"></div>
    <form asp-action="Register" method="post" id="mapForm">
        <div>
            <label asp-for="Melding">Beskrivelse</label>
            <textarea asp-for="Melding"></textarea>
        </div>
        <div>
            <input type="text" class="visually-hidden" id="Koordinater" asp-for="StringKoordinaterLag"></input>
        </div>
        <button type="submit" value="send" class="btn btn-primary" onclick="submitForm()">Send inn</button>
    </form>
</div>

@section Scripts {
    <script>
    // Lag som viser land eller sjø kart
    const layers = Object.freeze({
        Land: L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.kartdata?', {
            layers: "kd_arealdekkeflate,kd_veger,kd_bygninger,kd_jernbane",
            attribution: 'Kartverket'
        }),
        "Sjø": L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.kartdata?', {
            layers: "kd_arealdekkeflate,kd_vannkontur,kd_vannflate,kd_elver,kd_ferger",
            attribution: 'Kartverket'
        }),
    })
    
    const map = L.map('map').setView([58.151, 8], 13);

    map.pm.addControls({
        position: 'topleft',
        drawCircleMarker: false,
        rotateMode: false,
    });

    // Vi trenger locate til å hente lokasjon av bruker
    // L.control.locate().addTo(map);

    layers.Land.addTo(map);

    L.control.layers(layers).addTo(map);
    
    // Leverer kartdata til home-kontrolleren
    function submitForm() {
        const mapData = {
            points: [],
            lines: []
        };

        const markers = L.PM.Utils.findLayers(map);

        markers.forEach(marker => {
            if (marker.options.pane === "markerPane") mapData.points.push(marker._latlng);
            if (marker.options.pane === "overlayPane") mapData.points.push(marker_latlngs);
        });
          
        const koordinater = document.getElementById("Koordinater");
        
        if (!koordinater) throw new Error("500 Internal error");
        
        // Gjør om mapData til string
        koordinater.value = JSON.stringify(mapData);
        document.getElementById("mapForm").submit();
    }    
</script>
}

</body>
</html>
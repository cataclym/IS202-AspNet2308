@model FeilMeldingsModel

@{
    ViewData["Title"] = "Registrer utbedring på kart";
}

<!DOCTYPE html>

<html>
<head>
</head>
<body>
<div>
    <div id="map"></div>
    <form asp-action="Register" method="post" id="mapForm">
        <div>
            <label asp-for="Melding">Beskrivelse</label>
            <textarea asp-for="Melding"></textarea>
        </div>
        <div>
            <input type="text" class="visually-hidden" id="Koordinater" asp-for="StringKoordinaterLag"></input>
        </div>
        <button type="submit" value="send" class="btn btn-primary" onclick="submitForm()">Send inn</button>
    </form>
</div>

@section Scripts {
    <script>
    
    const map = lagKart();
    
    // Skrur av forskjellige tegnekontroller
    map.pm.addControls({
        position: 'topleft',
        rotateMode: false,
        drawMarker: false,
        drawCircleMarker: false,
        drawPolyline: false,
        drawCircle: false,
        drawText: false
    });
    
    // Leverer kartdata til home-kontrolleren
    function submitForm() {
        const mapData = {
            points: [],
            lines: []
        };

        const markers = L.PM.Utils.findLayers(map);

        markers.forEach(marker => {
            if (marker.options.pane === "markerPane") mapData.points.push(marker._latlng);
            if (marker.options.pane === "overlayPane") mapData.lines.push(marker._latlngs);
        });
                        
        const koordinater = document.getElementById("Koordinater");
        
        if (!koordinater) throw new Error("500 Internal error");
        
        // Gjør om mapData til string
        koordinater.value = JSON.stringify(mapData);
        document.getElementById("mapForm").submit();
    }    
</script>
}

</body>
</html>